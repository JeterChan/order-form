<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è¨‚è³¼å–®å¡«å¯«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- âœ… Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container my-5">
    <div class="mx-auto" style="max-width: 1080px;">
      <div class="card shadow">
        <div class="card-body">
          <h1 class="card-title mb-4">è¨‚è³¼å–®å¡«å¯«</h1>

          <form action="/submit-order" method="POST" id="orderForm" class="needs-validation" novalidate>
            <!-- ä½¿ç”¨è€…è³‡è¨Š -->
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">è¨‚è²¨å–®ä½ <span class="text-danger">*</span></label>
                <input type="text" name="company" class="form-control" required>
                <div class="invalid-feedback">è«‹è¼¸å…¥è¨‚è²¨å–®ä½</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">é›»è©±<span class="text-danger">*</span></label>
                <input type="tel" name="phone" class="form-control" required pattern="^09\d{8}$">
                <div class="invalid-feedback">è«‹è¼¸å…¥æœ‰æ•ˆçš„æ‰‹æ©Ÿè™Ÿç¢¼ï¼ˆä¾‹å¦‚ 09XXXXXXXXï¼‰</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">åœ°å€<span class="text-danger">*</span></label>
                <input type="text" name="address" class="form-control" required>
                <div class="invalid-feedback">è«‹è¼¸å…¥åœ°å€</div>
              </div>       
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" required>
                <div class="invalid-feedback">è«‹è¼¸å…¥æ­£ç¢ºçš„ Email</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">æŠ¬é ­</label>
                <input type="text" name="invoiceTitle" class="form-control">
              </div>
            
              <div class="col-md-6">
                <label class="form-label">çµ±ä¸€ç·¨è™Ÿ</label>
                <input type="text" name="taxId" class="form-control" pattern="^\d{8}$">
                <div class="invalid-feedback">çµ±ä¸€ç·¨è™Ÿéœ€ç‚º 8 ç¢¼æ•¸å­—</div>
              </div>
            
            </div>

            <!-- å•†å“å€å¡Š -->
            <h5 class="mt-5 mb-3">å•†å“å…§å®¹</h5>
            <div class="table-responsive">
              <table class="table table-bordered text-center align-middle" id="productTable">
                <thead class="table-light">
                  <tr>
                    <th>ç·¨è™Ÿ</th>
                    <th>å“å</th>
                    <th>è¦æ ¼</th>
                    <th>æ•¸é‡</th>
                    <th>å–®åƒ¹</th>
                    <th>ç¸½åƒ¹</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>

                <tbody id="productTbody">
                  <!-- åˆå§‹1åˆ— -->
                  <tr>
                    <td><input type="text" class="form-control" name="items[0][number]" required></td>
                    <td><input type="text" class="form-control" name="items[0][name]" required></td>
                    <td><input type="text" class="form-control" name="items[0][spec]"></td>
                    <td><input type="number" class="form-control quantity" name="items[0][quantity]" required></td>
                    <td><input type="number" class="form-control price" name="items[0][price]" required></td>
                    <td><input type="number" class="form-control total" name="items[0][total]" readonly></td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">åˆªé™¤</button></td>
                  </tr>
                </tbody>
              </table>
              <button type="button" class="btn btn-outline-primary" onclick="addRow()">â• æ–°å¢å•†å“</button>
            </div>

            <!-- â–¶ï¸ é¡¯ç¤ºç¸½é‡‘é¡ -->
            <div class="text-end mb-3">
              <h5>ç¸½é‡‘é¡ï¼š<span id="grandTotal" class="text-danger"></span></h5>
            </div>

            <!-- ğŸ§¾ ç¸½é‡‘é¡éš±è—æ¬„ä½ï¼Œé€çµ¦å¾Œç«¯ -->
            <input type="hidden" name="totalAmount" id="hiddenTotal">

            <!-- ä»˜æ¬¾èˆ‡å‚™è¨» -->
            <div class="mb-3 mt-4">
              <label class="form-label">ä»˜æ¬¾æ–¹å¼</label>
              <select class="form-select" name="paymentMethod" required>
                <option value="">è«‹é¸æ“‡</option>
                <option value="è½‰å¸³">è½‰å¸³</option>
                <option value="è²¨åˆ°ä»˜æ¬¾">è²¨åˆ°ä»˜æ¬¾</option>
              </select>
              <div class="invalid-feedback">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</div>
            </div>          

            <div class="mb-3">
              <label class="form-label">å‚™è¨»</label>
              <textarea class="form-control" name="notes" rows="3"></textarea>
            </div>

            <div class="text-end">
              <button type="submit" class="btn btn-primary">é€å‡ºè¨‚å–®</button>
            </div>
          </form>

          <!-- ğŸ“ é§¿è‹±ä¼æ¥­ç¤¾è¯çµ¡æ–¹å¼ -->
          <div class="text-center text-muted small mt-5">
            <hr>
            <p>é§¿è‹±ä¼æ¥­ç¤¾</p>
            <p>TEL: 04-7624868ã€04-7639856</p>
            <p>FAX: 04-7623685</p>
            <p>åœ°å€ï¼šå½°åŒ–å¸‚å´™å¹³å—è·¯139-3è™Ÿ</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- âœ… Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- âœ… å®¢è£½åŠŸèƒ½ JS -->
  <script>
    let rowIndex = 1;

    // â• æ–°å¢åˆ—
    function addRow() {
      const tbody = document.getElementById('productTbody');
      const row = document.createElement('tr');

     row.innerHTML = `
        <td><input type="text" class="form-control" name="items[${rowIndex}][number]" required></td>
        <td><input type="text" class="form-control" name="items[${rowIndex}][name]" required></td>
        <td><input type="text" class="form-control" name="items[${rowIndex}][spec]"></td>
        <td><input type="number" class="form-control quantity" name="items[${rowIndex}][quantity]" required></td>
        <td><input type="number" class="form-control price" name="items[${rowIndex}][price]" required></td>
        <td><input type="number" class="form-control total" name="items[${rowIndex}][total]" readonly></td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">åˆªé™¤</button></td>
      `;
      tbody.appendChild(row);
      rowIndex++;
      updateGrandTotal();
    }

    // ğŸ—‘ï¸ ç§»é™¤åˆ—
    function removeRow(button) {
      button.closest('tr').remove();
      updateGrandTotal();
      saveToLocal();
    }

    // âœ¨ è‡ªå‹•è¨ˆç®—ç¸½åƒ¹
    document.addEventListener('input', function (e) {
      if (e.target.classList.contains('quantity') || e.target.classList.contains('price')) {
        const row = e.target.closest('tr');
        const quantity = row.querySelector('.quantity').value;
        const price = row.querySelector('.price').value;
        const total = row.querySelector('.total');
        total.value = (quantity * price).toFixed(0);
      }
      saveToLocal();
    });

    // âœ… è¡¨å–®é©—è­‰
    (function () {
      'use strict';
      const form = document.querySelector('#orderForm');
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        } else {
          localStorage.removeItem('order-form-data');
        }
        form.classList.add('was-validated');
      }, false);
    })();

    // ğŸ’¾ LocalStorage å¿«å–
    const form = document.querySelector('#orderForm');
    const LS_KEY = 'order-form-data';

    function saveToLocal() {
      const data = new FormData(form);
      const obj = {};
      data.forEach((value, key) => {
        if (obj[key]) {
          if (!Array.isArray(obj[key])) obj[key] = [obj[key]];
          obj[key].push(value);
        } else {
          obj[key] = value;
        }
      });
      localStorage.setItem(LS_KEY, JSON.stringify(obj));
    }

    function loadFromLocal() {
      const data = JSON.parse(localStorage.getItem(LS_KEY));
      if (!data) return;
      Object.keys(data).forEach(name => {
        const el = form.querySelectorAll(`[name="${name}"]`);
        if (el.length > 1) {
          el.forEach((input, i) => input.value = data[name][i] || '');
        } else {
          const input = el[0];
          if (input) input.value = data[name];
        }
      });
    }

    // ğŸ§® è¨ˆç®—æ‰€æœ‰å•†å“ç¸½é‡‘é¡
    function updateGrandTotal() {
      let total = 0;
      document.querySelectorAll('.total').forEach(input => {
        total += parseFloat(input.value || 0);
      });
      document.getElementById('grandTotal').textContent = 'NT$ ' + total.toLocaleString();
      document.getElementById('hiddenTotal').value = total;
    }

    // ğŸ§® åœ¨æ•¸é‡/å–®åƒ¹è¼¸å…¥æ™‚ï¼ŒåŒæ™‚æ›´æ–°è©²åˆ—ç¸½åƒ¹ & æ‰€æœ‰åˆè¨ˆ
    document.addEventListener('input', function (e) {
      if (e.target.classList.contains('quantity') || e.target.classList.contains('price')) {
        const row = e.target.closest('tr');
        const qty = row.querySelector('.quantity').value;
        const price = row.querySelector('.price').value;
        const total = row.querySelector('.total');
        total.value = (qty * price).toFixed(0);
        updateGrandTotal(); // â• æ›´æ–°ç¸½é‡‘é¡
      }
      saveToLocal();
    });

    window.addEventListener('DOMContentLoaded', loadFromLocal);
  </script>
</body>
</html>
