<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>訂購單填寫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- ✅ Bootstrap 5 CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container my-5">
    <div class="mx-auto" style="max-width: 1080px;">
      <div class="card shadow">
        <div class="card-body">
          <h1 class="card-title mb-4">訂購單填寫</h1>

          <form action="/submit-order" method="POST" id="orderForm" class="needs-validation" novalidate>
            <!-- 使用者資訊 -->
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">訂貨單位 <span class="text-danger">*</span></label>
                <input type="text" name="company" class="form-control" required>
                <div class="invalid-feedback">請輸入訂貨單位</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">電話<span class="text-danger">*</span></label>
                <input type="tel" name="phone" class="form-control" required pattern="^09\d{8}$">
                <div class="invalid-feedback">請輸入有效的手機號碼（例如 09XXXXXXXX）</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">地址<span class="text-danger">*</span></label>
                <input type="text" name="address" class="form-control" required>
                <div class="invalid-feedback">請輸入地址</div>
              </div>       
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" name="email" class="form-control" required>
                <div class="invalid-feedback">請輸入正確的 Email</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">抬頭</label>
                <input type="text" name="invoiceTitle" class="form-control">
              </div>
            
              <div class="col-md-6">
                <label class="form-label">統一編號</label>
                <input type="text" name="taxId" class="form-control" pattern="^\d{8}$">
                <div class="invalid-feedback">統一編號需為 8 碼數字</div>
              </div>
            
            </div>

            <!-- 商品區塊 -->
            <h5 class="mt-5 mb-3">商品內容</h5>
            <div class="table-responsive">
              <table class="table table-bordered text-center align-middle" id="productTable">
                <thead class="table-light">
                  <tr>
                    <th>編號</th>
                    <th>品名</th>
                    <th>規格</th>
                    <th>數量</th>
                    <th>單價</th>
                    <th>總價</th>
                    <th>操作</th>
                  </tr>
                </thead>

                <tbody id="productTbody">
                  <!-- 初始1列 -->
                  <tr>
                    <td><input type="text" class="form-control" name="items[0][number]" required></td>
                    <td><input type="text" class="form-control" name="items[0][name]" required></td>
                    <td><input type="text" class="form-control" name="items[0][spec]"></td>
                    <td><input type="number" class="form-control quantity" name="items[0][quantity]" required></td>
                    <td><input type="number" class="form-control price" name="items[0][price]" required></td>
                    <td><input type="number" class="form-control total" name="items[0][total]" readonly></td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">刪除</button></td>
                  </tr>
                </tbody>
              </table>
              <button type="button" class="btn btn-outline-primary" onclick="addRow()">➕ 新增商品</button>
            </div>

            <!-- ▶️ 顯示總金額 -->
            <div class="text-end mb-3">
              <h5>總金額：<span id="grandTotal" class="text-danger"></span></h5>
            </div>

            <!-- 🧾 總金額隱藏欄位，送給後端 -->
            <input type="hidden" name="totalAmount" id="hiddenTotal">

            <!-- 付款與備註 -->
            <div class="mb-3 mt-4">
              <label class="form-label">付款方式</label>
              <select class="form-select" name="paymentMethod" required>
                <option value="">請選擇</option>
                <option value="轉帳">轉帳</option>
                <option value="貨到付款">貨到付款</option>
              </select>
              <div class="invalid-feedback">請選擇付款方式</div>
            </div>          

            <div class="mb-3">
              <label class="form-label">備註</label>
              <textarea class="form-control" name="notes" rows="3"></textarea>
            </div>

            <div class="text-end">
              <button type="submit" class="btn btn-primary">送出訂單</button>
            </div>
          </form>

          <!-- 📞 駿英企業社聯絡方式 -->
          <div class="text-center text-muted small mt-5">
            <hr>
            <p>駿英企業社</p>
            <p>TEL: 04-7624868、04-7639856</p>
            <p>FAX: 04-7623685</p>
            <p>地址：彰化市崙平南路139-3號</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ✅ 客製功能 JS -->
  <script>
    let rowIndex = 1;

    // ➕ 新增列
    function addRow() {
      const tbody = document.getElementById('productTbody');
      const row = document.createElement('tr');

     row.innerHTML = `
        <td><input type="text" class="form-control" name="items[${rowIndex}][number]" required></td>
        <td><input type="text" class="form-control" name="items[${rowIndex}][name]" required></td>
        <td><input type="text" class="form-control" name="items[${rowIndex}][spec]"></td>
        <td><input type="number" class="form-control quantity" name="items[${rowIndex}][quantity]" required></td>
        <td><input type="number" class="form-control price" name="items[${rowIndex}][price]" required></td>
        <td><input type="number" class="form-control total" name="items[${rowIndex}][total]" readonly></td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">刪除</button></td>
      `;
      tbody.appendChild(row);
      rowIndex++;
      updateGrandTotal();
    }

    // 🗑️ 移除列
    function removeRow(button) {
      button.closest('tr').remove();
      updateGrandTotal();
      saveToLocal();
    }

    // ✨ 自動計算總價
    document.addEventListener('input', function (e) {
      if (e.target.classList.contains('quantity') || e.target.classList.contains('price')) {
        const row = e.target.closest('tr');
        const quantity = row.querySelector('.quantity').value;
        const price = row.querySelector('.price').value;
        const total = row.querySelector('.total');
        total.value = (quantity * price).toFixed(0);
      }
      saveToLocal();
    });

    // ✅ 表單驗證
    (function () {
      'use strict';
      const form = document.querySelector('#orderForm');
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        } else {
          localStorage.removeItem('order-form-data');
        }
        form.classList.add('was-validated');
      }, false);
    })();

    // 💾 LocalStorage 快取
    const form = document.querySelector('#orderForm');
    const LS_KEY = 'order-form-data';

    function saveToLocal() {
      const data = new FormData(form);
      const obj = {};
      data.forEach((value, key) => {
        if (obj[key]) {
          if (!Array.isArray(obj[key])) obj[key] = [obj[key]];
          obj[key].push(value);
        } else {
          obj[key] = value;
        }
      });
      localStorage.setItem(LS_KEY, JSON.stringify(obj));
    }

    function loadFromLocal() {
      const data = JSON.parse(localStorage.getItem(LS_KEY));
      if (!data) return;
      Object.keys(data).forEach(name => {
        const el = form.querySelectorAll(`[name="${name}"]`);
        if (el.length > 1) {
          el.forEach((input, i) => input.value = data[name][i] || '');
        } else {
          const input = el[0];
          if (input) input.value = data[name];
        }
      });
    }

    // 🧮 計算所有商品總金額
    function updateGrandTotal() {
      let total = 0;
      document.querySelectorAll('.total').forEach(input => {
        total += parseFloat(input.value || 0);
      });
      document.getElementById('grandTotal').textContent = 'NT$ ' + total.toLocaleString();
      document.getElementById('hiddenTotal').value = total;
    }

    // 🧮 在數量/單價輸入時，同時更新該列總價 & 所有合計
    document.addEventListener('input', function (e) {
      if (e.target.classList.contains('quantity') || e.target.classList.contains('price')) {
        const row = e.target.closest('tr');
        const qty = row.querySelector('.quantity').value;
        const price = row.querySelector('.price').value;
        const total = row.querySelector('.total');
        total.value = (qty * price).toFixed(0);
        updateGrandTotal(); // ➕ 更新總金額
      }
      saveToLocal();
    });

    window.addEventListener('DOMContentLoaded', loadFromLocal);
  </script>
</body>
</html>
